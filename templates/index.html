{% extends "layout.html" %}

{% block content %}
<div class="ui container">

    <!-- Main Chart Section -->
    <h2>Stock Chart: Apple</h2>
    <div class="tradingview-widget-container">
        <div class="tradingview-widget-container__widget"></div>
        <div class="tradingview-widget-copyright">
            <a href="https://www.tradingview.com/" rel="noopener nofollow" target="_blank">
                <span class="blue-text">Track all markets on TradingView</span>
            </a>
        </div>
        <script type="text/javascript" src="https://s3.tradingview.com/external-embedding/embed-widget-advanced-chart.js" async>
        {
            "width": "100%",
            "height": "600",
            "symbol": "NASDAQ:AAPL",
            "interval": "D",
            "timezone": "Etc/UTC",
            "theme": "dark",
            "style": "1",
            "locale": "en",
            "allow_symbol_change": true,
            "hide_side_toolbar": false
        }
        </script>
    </div>

    <!-- Search Bar -->
    <div class="ui fluid icon input" style="background-color: #333; color: white; padding: 5px; border-radius: 5px;">
        <input id="stock-search" type="text" placeholder="Search for stocks..." autocomplete="on" style="background-color: #222; color: white;">
        <i class="search icon" style="color: white;"></i>
    </div>

    <!-- Stocks Table -->
    <table class="ui selectable striped inverted celled table" id="stocks-table" style="font-size: 14px; background-color: #222; color: white;">
        <thead>
            <tr>
                <th>Symbol</th>
                <th>Name</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for stock in stocks %}
            <tr>
                <td>{{ stock.symbol }}</td>
                <td>{{ stock.name }}</td>
                <td>
                    <a href="/stock/{{ stock.symbol }}" class="ui blue button">View</a>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <script>
    const searchInput = document.getElementById('stock-search');
    searchInput.addEventListener('keyup', function(event) {
        const query = this.value.trim();

        if (event.key === 'Enter') {
            fetchResults(query);
        }
    });

    function fetchResults(query) {
        fetch(`/search?q=${encodeURIComponent(query)}`)
            .then(response => response.text())
            .then(data => {
                const parser = new DOMParser();
                const doc = parser.parseFromString(data, 'text/html');
                const newRows = doc.querySelector('#stocks-table tbody').innerHTML;

                document.querySelector('#stocks-table tbody').innerHTML = newRows;
            })
            .catch(error => console.error('Error:', error));
    }
</script>

</div>
{% endblock %}
